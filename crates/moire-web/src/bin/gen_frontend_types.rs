use facet_typescript::TypeScriptGenerator;
use std::fs;
use std::path::PathBuf;

fn main() -> Result<(), String> {
    let mut tsgen = TypeScriptGenerator::new();

    tsgen.add_type::<moire_types::ConnectionsResponse>();
    tsgen.add_type::<moire_types::ConnectedProcessInfo>();
    tsgen.add_type::<moire_types::TriggerCutResponse>();
    tsgen.add_type::<moire_types::CutStatusResponse>();
    tsgen.add_type::<moire_types::ApiError>();
    tsgen.add_type::<moire_types::SqlRequest>();
    tsgen.add_type::<moire_types::QueryRequest>();
    tsgen.add_type::<moire_types::SqlResponse>();
    tsgen.add_type::<moire_types::SnapshotCutResponse>();
    tsgen.add_type::<moire_types::SnapshotSymbolicationUpdate>();
    tsgen.add_type::<moire_types::RecordStartRequest>();
    tsgen.add_type::<moire_types::RecordCurrentResponse>();
    tsgen.add_type::<moire_types::RecordingImportBody>();
    tsgen.add_type::<moire_types::SourcePreviewResponse>();
    tsgen.add_type::<moire_types::SourcePreviewBatchRequest>();
    tsgen.add_type::<moire_types::SourcePreviewBatchResponse>();

    let generated = tsgen.finish();
    let mut out = String::new();
    out.push_str("// @generated by `cargo run -p moire-web --bin gen_frontend_types`\n");
    out.push_str("// Do not edit by hand.\n\n");
    out.push_str(&generated);

    let out_path = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .join("..")
        .join("..")
        .join("frontend")
        .join("src")
        .join("api")
        .join("types.generated.ts");

    if let Some(dir) = out_path.parent() {
        fs::create_dir_all(dir)
            .map_err(|e| format!("failed to create output directory {}: {e}", dir.display()))?;
    }
    fs::write(&out_path, out)
        .map_err(|e| format!("failed to write {}: {e}", out_path.display()))?;

    println!("wrote {}", out_path.display());
    Ok(())
}
